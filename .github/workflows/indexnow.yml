name: IndexNow - é€šçŸ¥æœç´¢å¼•æ“Žç´¢å¼•æ›´æ–°

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/**'
      - '*.md'
      - '_config.yml'

jobs:
  notify-indexnow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # èŽ·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿æ¯”è¾ƒå˜åŒ–
      
      - name: Get changed files
        id: changed-files
        run: |
          # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '^_posts/.*\.md$|^.*\.md$' || true)
          
          # æž„å»º URL åˆ—è¡¨
          URLS=""
          for file in $CHANGED_FILES; do
            if [[ $file == _posts/* ]]; then
              # ä»Žæ–‡ä»¶åæå– slug: _posts/2024-10-17-neovim-cpp-setup.md -> neovim-cpp-setup
              filename=$(basename "$file" .md)
              slug=$(echo "$filename" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
              URLS="$URLS https://magic-alt.github.io/$slug/"
            fi
          done
          
          # åŽ»é‡å¹¶æ ¼å¼åŒ–
          URLS=$(echo "$URLS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/ $//')
          echo "urls=$URLS"
          echo "urls=$URLS" >> $GITHUB_OUTPUT
      
      - name: Submit to IndexNow
        if: steps.changed-files.outputs.urls != ''
        run: |
          # IndexNow API ç«¯ç‚¹ï¼ˆBing/Yandex éƒ½æ”¯æŒï¼‰
          INDEXNOW_ENDPOINT="https://api.indexnow.org/indexnow"
          
          # ä½ éœ€è¦ç”Ÿæˆä¸€ä¸ª IndexNow keyï¼ˆä»»æ„ UUID æ ¼å¼å­—ç¬¦ä¸²ï¼‰
          # å»ºè®®åœ¨ GitHub Secrets ä¸­è®¾ç½® INDEXNOW_KEY
          # æˆ–è€…ä½¿ç”¨å›ºå®šå€¼ï¼ˆéœ€è¦åœ¨ç½‘ç«™æ ¹ç›®å½•æ”¾ç½®å¯¹åº”çš„éªŒè¯æ–‡ä»¶ï¼‰
          INDEXNOW_KEY="${{ secrets.INDEXNOW_KEY }}"
          
          # å¦‚æžœæ²¡æœ‰è®¾ç½® secretï¼Œä½¿ç”¨ç¤ºä¾‹ keyï¼ˆéœ€è¦åˆ›å»ºéªŒè¯æ–‡ä»¶ï¼‰
          if [ -z "$INDEXNOW_KEY" ]; then
            INDEXNOW_KEY="your-indexnow-key-here"
            echo "âš ï¸  è­¦å‘Š: æœªè®¾ç½® INDEXNOW_KEY secretï¼Œä½¿ç”¨é»˜è®¤å€¼"
            echo "è¯·è®¿é—® https://www.indexnow.org/ äº†è§£å¦‚ä½•ç”Ÿæˆå’ŒéªŒè¯ key"
          fi
          
          # æäº¤æ¯ä¸ª URL
          for url in ${{ steps.changed-files.outputs.urls }}; do
            echo "ðŸ“¤ æäº¤ URL: $url"
            
            curl -X POST "$INDEXNOW_ENDPOINT" \
              -H "Content-Type: application/json" \
              -d "{
                \"host\": \"magic-alt.github.io\",
                \"key\": \"$INDEXNOW_KEY\",
                \"urlList\": [\"$url\"]
              }" || echo "âŒ æäº¤å¤±è´¥: $url"
            
            sleep 1  # é¿å…è¿‡å¿«è¯·æ±‚
          done
          
          echo "âœ… IndexNow é€šçŸ¥å®Œæˆ"
      
      - name: Summary
        if: steps.changed-files.outputs.urls != ''
        run: |
          echo "## IndexNow æäº¤æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å·²é€šçŸ¥ä»¥ä¸‹ URL æ›´æ–°ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for url in ${{ steps.changed-files.outputs.urls }}; do
            echo "- $url" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Bing/Yandex å°†åœ¨å‡ å°æ—¶å†…é‡æ–°æŠ“å–è¿™äº›é¡µé¢" >> $GITHUB_STEP_SUMMARY
